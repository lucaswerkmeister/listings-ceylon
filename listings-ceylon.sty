\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{listings-ceylon}[Ceylon language support for listings]

\RequirePackage{listings}

\lstdefinelanguage{ceylon}{
  morekeywords={
    assembly, module, package, import,
    alias, class, interface, object, given, value, assign, void, function, new,
    of, extends, satisfies, abstracts,
    in, out,
    return, break, continue, throw,
    assert, dynamic,
    if, else, switch, case, for, while, try, catch, finally, then, let,
    this, outer, super,
    is, exists, nonempty
  },
  morekeywords=[2]{
    shared, abstract, formal, default, actual, variable, late, native, deprecated, final, sealed, annotation, suppressWarnings, small, static
  },
  morekeywords=[3]{
    doc, by, license, see, throws, tagged
  },
  sensitive=true,
  morecomment=[l]{//},
  morecomment=[n]{/*}{*/},
  morestring=[b]",
  morestring=[b]',
}

\@ifpackageloaded{xcolor}{
  % all colors taken from plugins/org.eclipse.ceylon.ide.eclipse.ui/plugin.xml in the ceylon-ide-eclipse repository
  \definecolor{org.eclipse.ceylon.ide.eclipse.ui.theme.color.keywords}{RGB}{76,76,76}
  \definecolor{org.eclipse.ceylon.ide.eclipse.ui.theme.color.annotations}{RGB}{51,153,204}
  \definecolor{org.eclipse.ceylon.ide.eclipse.ui.theme.color.identifiers}{RGB}{0,51,153}
  \definecolor{org.eclipse.ceylon.ide.eclipse.ui.theme.color.types}{RGB}{153,0,102}
  \colorlet{org.eclipse.ceylon.ide.eclipse.ui.theme.color.numbers}{blue}
  \colorlet{org.eclipse.ceylon.ide.eclipse.ui.theme.color.strings}{blue}
  \colorlet{org.eclipse.ceylon.ide.eclipse.ui.theme.color.comments}{darkgray}
  % https://tex.stackexchange.com/a/4199/25264
  \newcommand*\ceylonIdeEclipseIdentifier{%
    \expandafter\ceylonIdeEclipseIdentifier@style\the\lst@token\relax%
  }
  \def\ceylonIdeEclipseIdentifier@style#1#2\relax{%
    \ifcat#1%
    \relax%
    \else%
    \ifnum`#1=\uccode`#1%
    \color{org.eclipse.ceylon.ide.eclipse.ui.theme.color.types}%
    \else%
    \color{org.eclipse.ceylon.ide.eclipse.ui.theme.color.identifiers}%
    \fi%
    \fi%
  }
  \lstdefinestyle{org.eclipse.ceylon.ide.eclipse.ui.theme}{
    basicstyle=\ttfamily,
    keywordstyle=\bfseries\color{org.eclipse.ceylon.ide.eclipse.ui.theme.color.keywords},
    keywordstyle=[2]\color{org.eclipse.ceylon.ide.eclipse.ui.theme.color.annotations},
    keywordstyle=[3]\color{org.eclipse.ceylon.ide.eclipse.ui.theme.color.annotations},
    identifierstyle=\ceylonIdeEclipseIdentifier,
    numberstyle=\color{org.eclipse.ceylon.ide.eclipse.ui.theme.color.numbers},
    stringstyle=\color{org.eclipse.ceylon.ide.eclipse.ui.theme.color.strings},
    commentstyle=\color{org.eclipse.ceylon.ide.eclipse.ui.theme.color.comments},
  }

  % all colors taken from typechecker/en/styles/ceylon.css in the ceylon repository
  \definecolor{ceylon.rainbow.comment}{HTML}{008b8b} % darkcyan
  \colorlet{ceylon.rainbow.constant.numeric}{blue}
  \colorlet{ceylon.rainbow.constant.string}{blue}
  \definecolor{ceylon.rainbow.entity.function}{RGB}{51,153,204}
  \definecolor{ceylon.rainbow.entity.class}{RGB}{153,0,102}
  \definecolor{ceylon.rainbow.variable.global}{RGB}{0,51,153}
  \definecolor{ceylon.rainbow.keyword}{RGB}{76,76,76}
  % https://tex.stackexchange.com/a/4199/25264
  \newcommand*\ceylonRainbowIdentifier{%
    \expandafter\ceylonRainbowIdentifier@style\the\lst@token\relax%
  }
  \def\ceylonRainbowIdentifier@style#1#2\relax{%
    \ifcat#1%
    \relax%
    \else%
    \ifnum`#1=\uccode`#1%
    \color{ceylon.rainbow.entity.class}%
    \else%
    \color{ceylon.rainbow.variable.global}%
    \fi%
    \fi%
  }
  \lstdefinestyle{ceylon.rainbow}{ % mostly identical to org.eclipse.ceylon.ide.eclipse.ui.theme â€“ see also https://github.com/eclipse/ceylon/issues/7343
    basicstyle=\ttfamily,
    keywordstyle=\bfseries\color{ceylon.rainbow.keyword},
    keywordstyle=[2]\color{ceylon.rainbow.entity.function},
    keywordstyle=[3]\color{ceylon.rainbow.entity.function},
    identifierstyle=\ceylonRainbowIdentifier,
    numberstyle=\color{ceylon.rainbow.constant.numeric},
    stringstyle=\color{ceylon.rainbow.constant.string},
    commentstyle=\color{ceylon.rainbow.comment},
  }

  % all colors taken from stylesheets/themes/paraiso-dark.css in the ceylon-lang.org repository
  \definecolor{ceylon.paraiso.background}{HTML}{2f1e2e}
  \definecolor{ceylon.paraiso.foreground}{HTML}{e7e9db}
  \definecolor{ceylon.paraiso.comment}{HTML}{776e71}
  \definecolor{ceylon.paraiso.constant.numeric}{HTML}{f99b15}
  \definecolor{ceylon.paraiso.constant.string}{HTML}{48b685}
  \definecolor{ceylon.paraiso.entity.function}{HTML}{06b6ef}
  \definecolor{ceylon.paraiso.entity.class}{HTML}{fec418}
  \definecolor{ceylon.paraiso.variable.global}{HTML}{ef6155}
  \definecolor{ceylon.paraiso.keyword}{HTML}{b8baaf}
  % https://tex.stackexchange.com/a/4199/25264
  \newcommand*\ceylonParaisoIdentifier{%
    \expandafter\ceylonParaisoIdentifier@style\the\lst@token\relax%
  }
  \def\ceylonParaisoIdentifier@style#1#2\relax{%
    \ifcat#1%
    \relax%
    \else%
    \ifnum`#1=\uccode`#1%
    \color{ceylon.paraiso.entity.class}%
    \else%
    \color{ceylon.paraiso.variable.global}%
    \fi%
    \fi%
  }
  \lstdefinestyle{ceylon.paraiso}{
    basicstyle=\ttfamily\color{ceylon.paraiso.foreground},
    backgroundcolor=\color{ceylon.paraiso.background},
    keywordstyle=\color{ceylon.paraiso.keyword},
    keywordstyle=[2]\color{ceylon.paraiso.entity.function},
    keywordstyle=[3]\color{ceylon.paraiso.entity.function},
    identifierstyle=\ceylonParaisoIdentifier,
    numberstyle=\color{ceylon.paraiso.constant.numeric},
    stringstyle=\color{ceylon.paraiso.constant.string},
    commentstyle=\color{ceylon.paraiso.comment},
  }
}{
  \lstdefinestyle{org.eclipse.ceylon.ide.eclipse.ui.theme}{
    basicstyle=\ttfamily,
    keywordstyle=\bfseries,
  }
  \lstdefinestyle{ceylon.rainbow}{
    basicstyle=\ttfamily,
    keywordstyle=\bfseries,
  }
  \lstdefinestyle{ceylon.paraiso}{
    basicstyle=\ttfamily,
  }
}

\newif\ifceylon@patchLstinline

\DeclareOption{ide}{
  \lstset{language=ceylon}
  \lstset{style=org.eclipse.ceylon.ide.eclipse.ui.theme}
}
\DeclareOption{website}{
  \lstset{language=ceylon}
  \lstset{style=ceylon.paraiso}
  \@ifpackageloaded{xcolor}{
    \ceylon@patchLstinlinetrue
  }{}
}

\ExecuteOptions{}
\ProcessOptions\relax

\ifceylon@patchLstinline
  % https://tex.stackexchange.com/a/357339/25264
  \RequirePackage{xpatch}
  \RequirePackage{realboxes}
  \xpretocmd\lstinline{\Colorbox{ceylon.paraiso.background}\bgroup\appto\lst@DeInit{\egroup}}{}{}
\fi

\endinput
